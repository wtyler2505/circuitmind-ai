# Project DNA -- CircuitMind AI

> Generated by /initref on 2026-02-09 (updated). For structural details, see @.ref/project-map.md

## Tech Stack
- **Runtime**: Node.js (Vite 6.x dev server, port 3000) + Express 5 backend (port 3001)
- **Framework**: React 19.2 (no Next.js -- pure SPA with Vite)
- **Language**: TypeScript 5.x (ES2022 target, bundler module resolution)
- **AI**: @google/genai 1.34 (Gemini 2.5 Pro/Flash, Imagen 3, Veo 2, TTS)
- **3D**: Three.js 0.182 (lazy-loaded ThreeViewer + AI code generation)
- **Collab**: Yjs 13.6 + y-webrtc (CRDT real-time collaboration)
- **Styling**: Tailwind CSS v4 + custom cyberpunk theme (neon cyan/purple)
- **Testing**: Vitest + jsdom + @testing-library/react; Playwright for visual
- **Backend**: Express.js + better-sqlite3 (server/, 15 REST endpoints)
- **Simulation**: MNA circuit solver (services/simulation/, 10 files, Web Worker offloading)

## Architecture in 30 Seconds
CircuitMind AI is a browser-based electronic circuit design tool with AI assistance. Users build wiring diagrams on an SVG canvas, manage component inventory, and get AI-powered suggestions via Gemini. State lives in 19 React Context providers (no Redux). Persistence is dual-layer: localStorage for small data, IndexedDB for large structures. A separate Express+SQLite backend handles advanced inventory (catalog, locations, stock moves, AI identification). The codebase is flat (no src/ directory) with 288 source files + 22 test files.

## Entry Points
| Concern | Start Here |
|---------|-----------|
| App bootstrap | `index.tsx` -> `App.tsx` (20 context providers) |
| Type system | `types.ts` (all interfaces, ~300 LOC) |
| Canvas/diagram | `components/DiagramCanvas.tsx` -> `components/diagram/` |
| AI integration | `services/gemini/client.ts` (singleton) -> `services/gemini/features/` |
| State | `contexts/*.tsx` (19 providers, nesting order in App.tsx matters) |
| Persistence | `services/storage.ts` (localStorage + IndexedDB) |
| Hooks | `hooks/useAIActions.ts` (action dispatch hub) |
| Backend API | `server/index.ts` -> `server/routes/` (9 route modules) |
| Simulation | `services/simulationEngine.ts` -> `services/simulation/` (MNA solver) |

## Onboarding Path (read in this order)
1. `types.ts` -- all interfaces; establishes the vocabulary (ElectronicComponent, WiringDiagram, ActionType)
2. `App.tsx` -- 20 context providers nested in load-bearing order; shows how state is structured
3. `contexts/InventoryContext.tsx` -- single source of truth for components; everything syncs from here
4. `contexts/DiagramContext.tsx` -- diagram state + undo/redo; depends on inventory being loaded first
5. `hooks/useInventorySync.ts` -- the glue: syncs inventory changes into diagram automatically
6. `services/gemini/client.ts` -- AI singleton with 15 model constants; understand before touching any AI feature
7. `components/DiagramCanvas.tsx` -- the payoff: orchestrates SVG canvas using 6 extracted hooks

## Active Development (last 90 days)
| File | Changes | What's Happening |
|------|---------|-----------------|
| components/MainLayout.tsx | 33 | Major refactor: 1014->608 LOC, hooks extracted |
| App.tsx | 31 | Provider nesting expanded to 20 (added AdvancedInventory, Sync) |
| components/Inventory.tsx | 23 | FZPZ integration, subcomponent extraction |
| components/DiagramCanvas.tsx | 20 | Refactored: 1226->313 LOC, hooks extracted |
| components/ChatPanel.tsx | 19 | Chat UI improvements |
| index.css | 18 | WCAG a11y CSS, reduced-motion, focus-visible |
| components/SettingsPanel.tsx | 18 | Focus trap integration, 7 sub-panels |
| vite.config.ts | 11 | Code-splitting, vendor chunks, bundle optimization |
| components/diagram/DiagramNode.tsx | 11 | Pin tooltip integration, MNA voltage/current display |
| services/gemini/features/chat.ts | 9 | Context limits, token overflow detection |

## Non-Obvious Conventions
- Flat root layout -- all code at project root, no `src/` directory
- Inventory is the single source of truth; diagram syncs FROM inventory via `useInventorySync`
- `liveSessionRef` uses `useRef` not `useState` (WebSocket reference)
- Provider nesting order in App.tsx is load-bearing (diagram depends on inventory)
- Action safety classification in `types.ts:ACTION_SAFETY` gates auto-execution
- Gemini schemas: OBJECT types MUST have `properties: {}` or API rejects
- Server runs on port 3001; Vite proxies `/api` to it in dev

## Architectural Decisions
- React Context over Redux: 19 domain-specific contexts instead of global store
- Dual persistence: localStorage for speed, IndexedDB for large datasets (quota handling built in)
- Code splitting: vendor-react, vendor-three, vendor-ai, vendor-ui, vendor-markdown, vendor-collab, vendor-git, vendor-charts, vendor-pdf chunks
- MNA simulation via Web Worker for circuits >20 nodes (disposable worker pattern)
- Express+SQLite backend for advanced inventory (catalog, locations, stock moves)

## Gotchas
- Gemini API key stored in `localStorage.cm_gemini_api_key`, set via `.env.local` GEMINI_API_KEY
- Add 100ms delay before `window.location.reload()` or state may not persist
- Z-index layers: Canvas(0) < Header(10) < Chat(20) < Inventory(40) < Modals(50)
- Veo video URLs need `&key=API_KEY` appended
- IndexedDB stores: INVENTORY, CONVERSATIONS, MESSAGES, plus binary FZPZ cache
- Server JSON.parse for DB fields needs try/catch -- corrupt data shouldn't crash exports
- locations.ts PUT route: whitelist field names to prevent SQL injection

## Environment
| Variable | Required | Purpose |
|----------|----------|---------|
| GEMINI_API_KEY | Yes | Gemini AI API key (via .env.local) |
| import.meta.env.DEV | Auto | Vite dev mode flag (gates axe-core) |

## Tech Debt Signals
- 1 TODO in `components/diagram/wiring/BezierWire.tsx:49`: "Implement Catmull-Rom or similar for smooth path through arbitrary points"

## Commands
| Task | Command |
|------|---------|
| Install | `npm install` |
| Dev | `npm run dev` (port 3000) |
| Build | `npm run build` |
| Test | `npm test` / `npm run test:watch` |
| Lint | `npm run lint` / `npm run lint:fix` |
| Format | `npm run format` / `npm run format:check` |
| Visual tests | `npm run test:visual` (Playwright) |
